try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="62770120-0db6-4205-867e-1d31d1913caa",e._sentryDebugIdIdentifier="sentry-dbid-62770120-0db6-4205-867e-1d31d1913caa")}catch(e){}{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{};e._sentryModuleMetadata=e._sentryModuleMetadata||{},e._sentryModuleMetadata[new e.Error().stack]=Object.assign({},e._sentryModuleMetadata[new e.Error().stack],{"_sentryBundlerPluginAppKey:anthropic-apps":!0})}"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[37131],{0x371cc700:(e,t,n)=>{n.d(t,{B:()=>s,N:()=>o});var a=n(0x22102fd88),i=n(0xfc89b4a4);let r=(0,i.createContext)(null),s=()=>{let e=(0,i.useContext)(r);return void 0===e?null:e},o=e=>{let{children:t,settings:n}=e;return(0,a.jsx)(r.Provider,{value:n,children:t})}},0x628a9a0b:(e,t,n)=>{n.d(t,{$z:()=>D,Bq:()=>M,C4:()=>ei,CW:()=>B,Du:()=>H,EV:()=>L,FG:()=>N,Fn:()=>k,HA:()=>W,HF:()=>en,HI:()=>X,Lo:()=>R,O2:()=>j,OZ:()=>V,Pt:()=>ee,Rs:()=>Z,Vt:()=>Y,WZ:()=>G,_W:()=>q,aC:()=>$,bT:()=>E,dy:()=>Q,gG:()=>F,lj:()=>et,mz:()=>S,oF:()=>er,of:()=>P,ou:()=>K,sk:()=>U,t7:()=>z,uE:()=>T,wR:()=>eo,x6:()=>O,yu:()=>A});var a=n(0xf32c56dd),i=n(0x12c9046cd),r=n(0x14de19ae8),s=n(0x371cc700),o=n(0x9845e38c),u=n(0x1de4b2c21),l=n(0x49fac030),c=n(0xac309a83),d=n(0xd126dc1a),g=n(0xe670e093),_=n(0x253a5c787),y=n(0x17e725145),v=n(0x1eb4fc9be),f=n(0x16ab3413b),p=n.n(f),m=n(0x4d348f95),h=n(0xfc89b4a4),w=n(0x78b33fbd),C=n(0x20805e624);let b=(e,t,n,a)=>{let i=new URLSearchParams;return i.append("tree","True"),i.append("rendering_mode","messages"),i.append("render_all_tools","true"),n&&i.append("consistency",n),a&&i.append("return_dangling_human_message","true"),"/api/organizations/".concat(e,"/chat_conversations/").concat(t,"?").concat(i.toString())},D=e=>{let t=(0,y.useQueryClient)(),{activeOrganization:n}=(0,r.YL)(),a=null==n?void 0:n.uuid,[i,s]=(0,h.useReducer)(e=>e+1,0),o=(0,d.f)([l.fC,{orgUuid:a},{uuid:e}]),u=(0,h.useMemo)(()=>{var e;return null==(e=t.getQueriesData({queryKey:o})[0])?void 0:e[1]},[t,o,e,i]);return(0,h.useEffect)(()=>t.getQueryCache().subscribe(e=>{"updated"===e.type&&"success"===e.action.type&&(0,v.MK)({queryKey:o},e.query)&&s()}),[t,s,o]),{data:u}},S=e=>{var t;let n=(0,y.useQueryClient)(),{activeOrganization:a}=(0,r.YL)(),i=null==a?void 0:a.uuid,s=(0,d.f)([l.fC,{orgUuid:i},{uuid:e}]);return null==(t=n.getQueriesData({queryKey:s})[0])?void 0:t[1]},U=30,Q=1e4,x=e=>{let{limit:t,offset:n,starred:a,searchQuery:i}=e,r=new URLSearchParams;return void 0!==t&&r.append("limit",t.toString()),void 0!==n&&r.append("offset",n.toString()),void 0!==a&&r.append("starred",a.toString()),void 0!==i&&r.append("searchQuery",i),r},L=e=>{let{limit:t,offset:n,enabled:s=!0,starred:o,searchQuery:u}=e,{track:c}=(0,a.st)(),{activeOrganization:d}=(0,r.YL)(),g=null==d?void 0:d.uuid,_=x({limit:t,offset:n,starred:o,searchQuery:u}),y=(0,w.useDynamicConfig)("claudeai_api_client"),v=y.get("conversations_stale_time_sec",300),f=y.get("conversations_only_strong_consistency_for_invalidation",!1),p=y.get("conversations_force_refresh_window_secs",0),m=y.get("conversations_explicit_strong_consistency",!0),C=f,b="conversations_last_timestamp_".concat(_);if(p>0){let e=window.sessionStorage.getItem(b),t=parseInt(null!=e?e:"",10);!isNaN(t)&&Date.now()-t<1e3*p&&(C=!1)}C?_.append("consistency","eventual"):m&&_.append("consistency","strong");let D=(0,i.Sk)("/api/organizations/".concat(null!=g?g:"","/chat_conversations").concat(_?"?".concat(_):""),{queryKey:[l.DC,{orgUuid:g},{limit:t,offset:n,starred:o,searchQuery:u}],staleTime:1e3*v,enabled:!!g&&s}),{dataUpdatedAt:S}=D;return(0,h.useEffect)(()=>{if(S<=0||p<=0)return;let e=window.sessionStorage.getItem(b),t=parseInt(null!=e?e:"",10);if(!isNaN(t)&&S>t){let e=S-t;e<(p+1)*1e3&&c({event_key:"chat.conversations.force_refresh",time_since_last_query_ms:e})}window.sessionStorage.setItem(b,S.toString())},[S,p,b,c]),D},k=()=>{let{activeOrganization:e}=(0,r.YL)(),t=null==e?void 0:e.uuid;return(0,i.Sk)("/api/organizations/".concat(t,"/chat_conversations/count_all"),{queryKey:[l.Ad,{orgUuid:t}],staleTime:3e5,enabled:!!t,meta:{noToast:!0}})},T=()=>{let e=(0,w.useDynamicConfig)("claudeai_api_client"),t=e.get("conversations_desktop_fetch_eventual_consistency",!1),n=e.get("conversations_explicit_strong_consistency",!0),{activeOrganization:a}=(0,r.YL)(),s=(0,i.mn)();return(0,h.useCallback)(async e=>{let{limit:i,offset:r}=e,o=new URLSearchParams;void 0!==i&&o.append("limit",i.toString()),void 0!==r&&o.append("offset",r.toString()),t?o.append("consistency","eventual"):n&&o.append("consistency","strong");let u=o.toString();return u=u?"?".concat(u):"",(await s("/api/organizations/".concat(null==a?void 0:a.uuid,"/chat_conversations").concat(u))).json()},[null==a?void 0:a.uuid,s,t,n])},P=()=>{let e=(0,h.useRef)(null),{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid,a=(0,y.useQueryClient)(),s=(0,i.mn)(),o=(0,c.fS)("claude_ai_prefetch");return(0,h.useCallback)(t=>{if(!n||!t||!o)return;if("undefined"!=typeof navigator&&"connection"in navigator&&navigator.connection){let e=navigator.connection;if("slow-2g"===e.effectiveType||"2g"===e.effectiveType||"3g"===e.effectiveType||void 0!==e.downlink&&e.downlink<1.5||e.saveData)return}let i=[l.fC,{orgUuid:n},{uuid:t}];if(a.isFetching({queryKey:i}))return;e.current&&e.current.abort(),e.current=new AbortController;let r=e.current,u=b(n,t,"eventual"),c=()=>{a.prefetchQuery({queryKey:i,queryFn:async()=>{try{let e=await s(u,{signal:r.signal}),t=await e.json();return(0,C.H6)(t)}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}},staleTime:3e5}).catch(e=>{if(!(e instanceof Error)||"AbortError"!==e.name)throw e})};"undefined"!=typeof requestIdleCallback?requestIdleCallback(c):c()},[n,o,a,s])},M=function(e){let{suppressError:t,enabled:n,returnDanglingHumanMessage:s}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{enabled:!0},{activeOrganization:o}=(0,r.YL)(),u=null==o?void 0:o.uuid,c=(0,h.useRef)([]),{track:d}=(0,a.st)(),g=e.startsWith("session_")||e.startsWith("local_"),_=(0,w.useDynamicConfig)("claudeai_api_client"),y=_.get("messages_force_refresh_window_secs",0),v=null==_?void 0:_.get("messages_explicit_strong_consistency",!0),f=y>0,m="messages_last_timestamp_".concat(e);if(y>0){let e=window.sessionStorage.getItem(m),t=parseInt(null!=e?e:"",10);!isNaN(t)&&Date.now()-t<1e3*y&&(f=!1)}let D=b(null!=u?u:"",e,f?"eventual":v?"strong":void 0,s),S=(0,i.Sk)(D,{queryKey:[l.fC,{orgUuid:u},{uuid:e},{returnDanglingHumanMessage:!!s}],staleTime:3e5,enabled:!!u&&!!e&&n&&!g,forceExplicitCache:!0,meta:{noToast:t}},e=>(0,C.H6)(e,s)),{dataUpdatedAt:U}=S;(0,h.useEffect)(()=>{if(U<=0||y<=0)return;let e=window.sessionStorage.getItem(m),t=parseInt(null!=e?e:"",10);if(!isNaN(t)&&U>t){let e=U-t;e<(y+1)*1e3&&d({event_key:"chat.messages.force_refresh",time_since_last_query_ms:e})}window.sessionStorage.setItem(m,U.toString())},[U,y,m,d]);let Q=(0,h.useMemo)(()=>{if(!S.data)return c.current=[],c.current;let e=(0,C.$)(S.data);return(e.length!==c.current.length||e.some((e,t)=>{var n;return e.uuid!==(null==(n=c.current[t])?void 0:n.uuid)||!p()(e,c.current[t])}))&&(c.current=e),c.current},[S.data]);return{...S,currentPath:Q}},q=e=>{let t=(0,y.useQueryClient)(),{activeOrganization:n}=(0,r.YL)(),a=null==n?void 0:n.uuid;return(0,h.useCallback)(()=>{ei(t,a,e)},[t,a,e])},E=(e,t)=>{let{mutateAsync:n}=B(),a=(0,m.useRouter)(),i=t||(0,g.b)();return(0,h.useCallback)(function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{model:void 0,controlsOpen:!1},r={uuid:i,name:"",model:t.model};t.createMode&&(r.create_mode=t.createMode),t.projectUuid&&(r.project_uuid=t.projectUuid),n(r).then(()=>{let n="/chat/".concat(i).concat(t.controlsOpen?"?controls=1":"");a[e](n)}).catch(e=>{(0,_.Cp)(e)})},[n,a,e,i])};function I(e){var t,n,a,i,r;return{chat_messages:null!=(t=null==e?void 0:e.chat_messages)?t:[],messageByUuid:null!=(n=null==e?void 0:e.messageByUuid)?n:new Map,parentByChildUuid:null!=(a=null==e?void 0:e.parentByChildUuid)?a:new Map,childrenByParentUuid:null!=(i=null==e?void 0:e.childrenByParentUuid)?i:new Map,selectedChildByUuid:null!=(r=null==e?void 0:e.selectedChildByUuid)?r:new Map}}function K(){let e=new Date().toISOString();return{summary:"",created_at:e,updated_at:e,...I()}}let B=()=>{let{activeOrganization:e}=(0,r.YL)(),t=null==e?void 0:e.uuid,{track:n}=(0,a.st)(),s=(0,w.useDynamicConfig)("claudeai_api_client"),o=(0,y.useQueryClient)();return(0,i.L2)("/api/organizations/".concat(null!=t?t:"","/chat_conversations"),"POST",{enabled:!!t,onSuccess:(e,a)=>{let i;if(o.setQueryData((i=e.uuid,[l.fC,{orgUuid:t},{uuid:i},{returnDanglingHumanMessage:!1}]),t=>({...t||{},...e,...I(t)})),s.get("skip_invalidate_create_conversation",!1)){if(!a.is_temporary){let n=[l.DC,{orgUuid:t},{limit:U,starred:!1}];o.setQueryData(n,t=>[e,...null!=t?t:[]])}}else n({event_key:"chat.conversations.invalidate",action:"create"}),ea(o,t)}})},z=()=>{let{activeOrganization:e}=(0,r.YL)(),t=null==e?void 0:e.uuid,{track:n}=(0,a.st)(),s=(0,w.useDynamicConfig)("claudeai_api_client"),o=(0,y.useQueryClient)(),u={queryKey:[l.DC,{orgUuid:t}]};return(0,i.L2)(e=>"/api/organizations/".concat(null!=t?t:"","/chat_conversations/").concat(e.uuid),"DELETE",{enabled:!!t,async onMutate(e){await o.cancelQueries(u);let t=new Map;return o.getQueriesData(u).forEach(e=>{let[n,a]=e;a&&t.set(n,a)}),o.setQueriesData(u,t=>t?t.filter(t=>t.uuid!==(null==e?void 0:e.uuid)):t),t},onError(e,t,n){n&&n.forEach((e,t)=>{o.setQueryData(t,e)})},async onSuccess(e,a){o.removeQueries({queryKey:[l.fC,{orgUuid:t},{uuid:a.uuid}]}),a.project_uuid&&o.setQueriesData({queryKey:[l.yF,{orgUuid:t,projectUuid:a.project_uuid}]},e=>e?{...e,data:e.data.filter(e=>e.uuid!==a.uuid)}:e),s.get("skip_invalidate_delete_conversation",!1)||(n({event_key:"chat.conversations.invalidate",action:"delete"}),await ea(o,t))}})},Y=e=>{let{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid,s=(0,y.useQueryClient)(),{track:o}=(0,a.st)();return(0,i.L2)("/api/organizations/".concat(n,"/chat_conversations/delete_many"),"POST",{onSuccess:async t=>{o({event_key:"chat.conversations.invalidate",action:"delete_many"}),await ea(s,n),e&&e(t)}})},O=e=>{let{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid,s=(0,y.useQueryClient)(),{track:o}=(0,a.st)();return(0,i.L2)("/api/organizations/".concat(n,"/chat_conversations/move_many"),"POST",{onSuccess:async t=>{o({event_key:"chat.conversations.invalidate",action:"move_many"}),await ea(s,n),await ei(s,n,t.moved),e&&e(t)}})},A=()=>{let{activeOrganization:e}=(0,r.YL)(),t=null==e?void 0:e.uuid;return(0,i.Sk)("/api/organizations/".concat(t,"/shares"),{queryKey:[l._J,{orgUuid:t}],enabled:!!t,staleTime:3e5})},j=e=>{let{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid;return(0,i.Sk)("/api/organizations/".concat(n,"/chat_conversations/").concat(e,"/latest"),{enabled:!1,queryKey:[l.XF,{orgUuid:n,conversationUuid:e}],staleTime:0,meta:{noToast:!0}},e=>{let{snapshot:t,shareable:n,disabled_reason:a}=e;return{shareable:n,disabled_reason:a,snapshot:t?{...t,chat_messages:t.chat_messages.map(e=>(0,C.XU)(e))}:null}})},N=e=>{let{activeOrganization:t,account:n}=(0,r.YL)(),a=null==t?void 0:t.uuid,s=n&&a?"/api/organizations/".concat(a,"/chat_snapshots/").concat(e,"?rendering_mode=messages&render_all_tools=true"):"/api/chat_snapshots/".concat(e,"?rendering_mode=messages&render_all_tools=true");return(0,i.Sk)(s,{retry:!1,refetchInterval:!1,enabled:!!e,staleTime:0,queryKey:[l.Bn,{orgUuid:a,snapshotUuid:e}]},e=>({...e,chat_messages:e.chat_messages.map(e=>(0,C.XU)(e))}))},H=e=>{let{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid,a=(0,y.useQueryClient)();return(0,i.L2)("/api/organizations/".concat(n,"/chat_conversations/").concat(e,"/share"),"POST",{onSuccess:()=>{a.invalidateQueries({queryKey:[l._J,{orgUuid:n}]}),a.invalidateQueries({queryKey:[l.A2,{orgUuid:n}]})}})},F=(e,t)=>{let{activeOrganization:n}=(0,r.YL)(),a=null==n?void 0:n.uuid,s=(0,y.useQueryClient)();return(0,i.L2)("/api/organizations/".concat(a,"/share/").concat(t),"DELETE",{enabled:!!a&&!!t,meta:{errorMessage:"There was an error while trying to unshare the conversation. Please try again."},onSuccess:()=>{s.invalidateQueries({queryKey:[l._J,{orgUuid:a}]}),s.invalidateQueries({queryKey:[l.A2,{orgUuid:a}]})}})},R=e=>{let{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid;return(0,i.Sk)("/api/organizations/".concat(n,"/artifact-versions/").concat(e),{retry:!1,refetchInterval:!1,enabled:!!e&&!!n,staleTime:0,queryKey:[l.Fz,{artifactVersionUuid:e}]})},W=function(e,t,n){var o,u,l;let c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},{track:d}=(0,a.st)(),g=null!=(u=null==(o=(0,s.B)())?void 0:o.preview_feature_uses_artifacts)&&u,{activeOrganization:_}=(0,r.YL)(),v=null==_?void 0:_.uuid,f=(0,y.useQueryClient)();return(0,i.L2)("/api/organizations/".concat(null!=v?v:"","/chat_conversations/").concat(e,"/chat_messages/").concat(null!=(l=t.uuid)?l:"","/chat_feedback"),t.chat_feedback?"PUT":"POST",{enabled:!!v,meta:{errorMessage:"We could not save your feedback. Please try again later."},...c,onSuccess(){for(var a,i,r=arguments.length,s=Array(r),o=0;o<r;o++)s[o]=arguments[o];d({event_key:"claudeai.conversation.feedback.sent",message_uuid:t.uuid,conversation_uuid:e,artifacts_enabled:g,conversationHasArtifacts:n,type:null==(a=t.chat_feedback)?void 0:a.type}),ei(f,v,e),null==(i=c.onSuccess)||i.call(c,...s)}})},J=()=>{let e=(0,y.useQueryClient)(),{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid;return(0,h.useCallback)((t,a)=>{t&&(e.setQueryData([l.fC,{orgUuid:n},{uuid:t},{returnDanglingHumanMessage:!1}],e=>e&&{...e,...a}),e.setQueriesData({queryKey:[l.DC,{orgUuid:n}]},e=>null==e?void 0:e.map(e=>e.uuid!==t?e:{...e,...a})))},[n,e])},X=(e,t)=>{let n=(0,y.useQueryClient)(),{activeOrganization:a}=(0,r.YL)(),s=null==a?void 0:a.uuid,o=J();return(0,i.L2)("/api/organizations/".concat(s,"/chat_conversations/").concat(e),"PUT",{onMutate:a=>{var i;let r,{name:u}=a,c=n.getQueryData([l.fC,{orgUuid:s},{uuid:e},{returnDanglingHumanMessage:!1}]);if(o(e,{name:u}),t){let a={queryKey:[l.yF,{orgUuid:s,projectUuid:t}]},i=n.getQueriesData(a);i.length>0&&i[0][1]&&(r=i[0][1]),n.setQueriesData(a,t=>t?{...t,data:t.data.map(t=>t.uuid===e?{...t,name:u}:t)}:t)}return{oldTitle:null!=(i=null==c?void 0:c.name)?i:"",prevProjectConversations:r}},onError(a,i,r){r&&(o(e,{name:r.oldTitle}),t&&r.prevProjectConversations&&n.setQueriesData({queryKey:[l.yF,{orgUuid:s,projectUuid:t}]},()=>r.prevProjectConversations))}})},G=e=>{let{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid,a=J();return(0,i.L2)("/api/organizations/".concat(n,"/chat_conversations/").concat(e,"/model_fallback"),"PUT",{onSuccess:t=>{a(e,{model:t.model})}})},V=e=>{let t=J(),{activeOrganization:n}=(0,r.YL)();return(0,i.L2)("/api/organizations/".concat(null==n?void 0:n.uuid,"/chat_conversations/").concat(e,"/title"),"POST",{onSuccess(n){let{title:a}=n;t(e,{name:null!=a?a:""})},meta:{noToast:!0}})};function Z(e){var t,n;let a=(0,u.C)(e),i=e.attachments.map(e=>e.extracted_content).join(" ");return a+" "+i+" "+((null==(t=e.content)?void 0:t.filter(e=>"tool_use"===e.type).map(e=>e.input?JSON.stringify(e.input):e.partial_json||"").join(" "))||"")+" "+((null==(n=e.content)?void 0:n.filter(e=>"tool_result"===e.type).flatMap(e=>"string"==typeof e.content?[e.content]:Array.isArray(e.content)?e.content.filter(e=>"text"===e.type).map(e=>e.text):[]).join(" "))||"")}let $=e=>{let{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid;return(0,i.L2)("/api/organizations/".concat(n,"/chat_conversations/").concat(e,"/stop_response"),"POST")},ee=()=>{let{activeOrganization:e}=(0,r.YL)(),t=null==e?void 0:e.uuid;return(0,i.L2)(e=>{let{conversation_uuid:n}=e;return"/api/organizations/".concat(t,"/chat_conversations/").concat(n,"/tool_result")},"POST",{enabled:!!t,meta:{errorMessage:"We could not record the tool result. Please try again later."},transformVariables:e=>{let{conversation_uuid:t,...n}=e;return n}})},et=e=>{let{activeOrganization:t}=(0,r.YL)(),n=null==t?void 0:t.uuid;return(0,i.L2)("/api/organizations/".concat(n,"/chat_conversations/").concat(e,"/current_leaf_message_uuid"),"PUT")},en=(e,t)=>{let{activeOrganization:n}=(0,r.YL)(),s=(0,y.useQueryClient)(),o=null==n?void 0:n.uuid,{track:u}=(0,a.st)(),c=(0,w.useDynamicConfig)("claudeai_api_client").get("conversations_skip_invalidation_on_settings_update",!0);return(0,i.Qv)("/api/organizations/".concat(o,"/chat_conversations/").concat(e,"?rendering_mode=raw"),"PUT",(e,t)=>t?{...t,settings:{...t.settings,...e.settings}}:void 0,{enabled:!!e,onSuccess:t=>{c?t.settings&&s.setQueryData([l.fC,{orgUuid:o},{uuid:e},{returnDanglingHumanMessage:!1}],e=>e?{...e,settings:t.settings}:e):(u({event_key:"chat.conversations.invalidate",action:"update_settings"}),ea(s,o))},onSettled:()=>{(null==t?void 0:t.refetchOnSettled)&&!c&&s.refetchQueries({queryKey:[l.fC,{orgUuid:o},{uuid:e}]})},queryKey:[l.fC,{orgUuid:o},{uuid:e}]})},ea=async(e,t)=>{if(!t)return;let n=(0,c.Je)(),a=null==n?void 0:n.getDynamicConfig("claudeai_api_client"),i=null==a?void 0:a.get("conversations_only_strong_consistency_for_invalidation",!1),r=null==a?void 0:a.get("conversations_explicit_strong_consistency",!0);if(i){await e.cancelQueries({queryKey:[l.DC,{orgUuid:t}]});let n=e.getQueryCache().findAll({queryKey:[l.DC,{orgUuid:t}]});await Promise.all(n.map(async n=>{let[a,i,s]=n.queryKey;if(!n.isActive())return;let u=x(s);r&&u.append("consistency","strong");let l="/api/organizations/".concat(t,"/chat_conversations").concat(u.size?"?".concat(u):"");try{let a=await fetch(l,{credentials:"include"});if(!a.ok)return void o.v.error(o.u.CHAT_COMPLETION,"Failed to fetch conversations during invalidation",{orgUuid:t,url:l,status:a.status});let i=await a.json();e.setQueryData(n.queryKey,i)}catch(e){o.v.error(o.u.CHAT_COMPLETION,"Error while fetching conversations during invalidation",{orgUuid:t,url:l,error:e})}})),await e.invalidateQueries({queryKey:[l.Ad,{orgUuid:t}]})}else{var s;let n=null!=(s=null==a?void 0:a.get("conversations_invalidation_delay_ms",0))?s:0;n>0&&await new Promise(e=>setTimeout(e,n)),await Promise.all([e.invalidateQueries({queryKey:[l.DC,{orgUuid:t}]}),e.invalidateQueries({queryKey:[l.Ad,{orgUuid:t}]})])}},ei=async(e,t,n)=>{var a;let i=(0,c.Je)(),r=null==i?void 0:i.getDynamicConfig("claudeai_api_client"),s=null!=(a=null==r?void 0:r.get("messages_invalidation_delay_ms",0))?a:0;s>0&&await new Promise(e=>setTimeout(e,s));let o=Array.isArray(n)?n:[n];await Promise.all(o.map(n=>e.invalidateQueries({queryKey:[l.fC,{orgUuid:t},{uuid:n}]})))},er=()=>{let e=(0,y.useQueryClient)(),t=(0,i.mn)(),{track:n}=(0,a.st)();return(0,h.useCallback)(async(a,i,r)=>{var s;let o=(0,c.Je)(),u=null==o?void 0:o.getDynamicConfig("claudeai_api_client");null!=(s=null==u?void 0:u.get("stream_rerender_query_replica",!1))&&s&&i&&r?await es(e,t,n,i,a,r):await ei(e,i,a)},[e,t,n])},es=async(e,t,n,a,i,r)=>{let s,u=[100,200,400];for(let n=0;n<u.length;n++)try{let s=u[n];await new Promise(e=>setTimeout(e,s));let o=b(a,i,"eventual"),c=await t(o),d=await c.json(),g=(0,C.H6)(d);if(g.messageByUuid.has(r))return void e.setQueryData([l.fC,{orgUuid:a},{uuid:i},{returnDanglingHumanMessage:!1}],g)}catch(e){s=e}o.v.error(o.u.CHAT_COMPLETION,"Failed all attempts to invalidate conversation tree with consistency=eventual",{conversationUuid:i,latestMessageUuid:r,error:s}),await ei(e,a,i)},eo=e=>{let{activeOrganization:t}=(0,r.YL)(),n=(0,y.useQueryClient)(),s=null==t?void 0:t.uuid,{track:o}=(0,a.st)(),u=(0,w.useDynamicConfig)("claudeai_api_client").get("conversations_skip_optimistic_invalidation",!1);return(0,i.Qv)("/api/organizations/".concat(s,"/chat_conversations/").concat(e,"?rendering_mode=raw"),"PUT",(e,t)=>t?{...t,...e}:void 0,{onSuccess:()=>{u||(o({event_key:"chat.conversations.invalidate",action:"star"}),ea(n,s))},queryKey:[l.fC,{orgUuid:s},{uuid:e}]})}},0xd126dc1a:(e,t,n)=>{n.d(t,{f:()=>i});var a=n(0xfc89b4a4);function i(e){let t=JSON.stringify(e);return(0,a.useMemo)(()=>e,[t])}},0xe670e093:(e,t,n)=>{n.d(t,{b:()=>a});let a=()=>void 0===crypto.randomUUID?"".concat(1e7,"-",1e3,"-",4e3,"-",8e3,"-",1e11).replace(/[018]/g,e=>{let t=parseInt(e);return(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)}):crypto.randomUUID()},0x1de4b2c21:(e,t,n)=>{n.d(t,{C:()=>a});let a=e=>{let t="";if(e.content)for(let n of e.content)"text"===n.type&&(t+=n.text);return t}},0x20805e624:(e,t,n)=>{n.d(t,{$:()=>f,AP:()=>d,B6:()=>s,EL:()=>o,GN:()=>l,Gp:()=>c,H6:()=>_,XU:()=>g,ZQ:()=>y,gF:()=>u,gX:()=>p,xQ:()=>v});var a=n(0x253a5c787),i=n(0x1da431fc8),r=n.n(i);let s="new-assistant-message-uuid",o="new-human-message-uuid",u="00000000-0000-4000-8000-000000000000",l=e=>!e.startsWith(s)&&!e.startsWith(o);function c(e,t){let n=e.get(t);if(void 0===n){let e=Error("Key not found: ".concat(t));throw(0,a.Cp)(e),e}return n}let d=(e,t)=>{let n=null!=t?t:e.current_leaf_message_uuid;if(!n)return e;let i=new Set;for(;n!==u;){if(i.has(n)){let e=Error("Circular reference detected in message tree at UUID: ".concat(n));throw(0,a.Cp)(e),e}i.add(n);let t=e.parentByChildUuid.get(n);if(void 0===t){(0,a.Cp)(Error("Incomplete parent chain at UUID: ".concat(n)));break}let r=e.childrenByParentUuid.get(t);if(void 0===r){(0,a.Cp)(Error("Missing children for parent UUID: ".concat(t)));break}let s=r.indexOf(n);e.selectedChildByUuid.set(t,s),n=t}return{...e,current_leaf_message_uuid:t}},g=e=>e.content?e:{...e,content:[{type:"text",text:e.text||"",citations:[]}]},_=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!(null==e?void 0:e.chat_messages))throw Error("Invalid conversation data: missing chat_messages");let n=new Map;for(let t of e.chat_messages)n.set(t.uuid,t);let a=new Set;for(let t of e.chat_messages)"assistant"===t.sender&&t.parent_message_uuid&&a.add(t.parent_message_uuid);let i=new Set;for(let n of e.chat_messages)("assistant"===n.sender||a.has(n.uuid)||void 0===n.parent_message_uuid||t)&&i.add(n.uuid);for(let e of Array.from(i)){let t=n.get(e);for(;(null==t?void 0:t.parent_message_uuid)&&!i.has(t.parent_message_uuid);)i.add(t.parent_message_uuid),t=n.get(t.parent_message_uuid)}let r=e.chat_messages.filter(e=>i.has(e.uuid)),s=e.chat_messages.filter(e=>!r.includes(e)&&"human"===e.sender),o={...e,chat_messages:r},l={...o,...(e=>{var t,n,a;let i=new Map,r=new Map,s=new Map,o=new Map,l=new Map;if(0===e.chat_messages.length)return{messageByUuid:r,parentByChildUuid:s,childrenByParentUuid:o,selectedChildByUuid:l};let c=e.chat_messages.map(g);for(let e of c)i.set(e.index,e),r.set(e.uuid,e);for(let e of c){let t=e.parent_message_uuid;if(!t){let a=e.index-1;for(;!t&&a>=0;)t=null==(n=i.get(a))?void 0:n.uuid,a--}t=null!=t?t:u,s.set(e.uuid,t),o.set(t,(null!=(a=o.get(t))?a:[]).concat(e.uuid)),l.set(t,0)}if(!(null==(t=o.get(u))?void 0:t[0]))throw Error("No root message found");return{chat_messages:c,messageByUuid:r,parentByChildUuid:s,childrenByParentUuid:o,selectedChildByUuid:l}})(o),danglingHumanMessages:s};l.current_leaf_message_uuid||d(l);let c=o.current_leaf_message_uuid;if(c&&!l.parentByChildUuid.has(c)){var _;if(!(c=null==(_=r[r.length-1])?void 0:_.uuid))return l}return d(l,c)},y=e=>{let t=Array.from(e.messageByUuid.values()).map(e=>e.index).filter(e=>void 0!==e);return 0===t.length?-1:Math.max(...t)},v=(e,t)=>{if(0===t.length)return e;for(let a of(e.chat_messages=e.chat_messages.concat(t),t)){var n;if(!a.parent_message_uuid)throw Error("Parent UUID required");let t=a.parent_message_uuid;e.messageByUuid.set(a.uuid,a),e.parentByChildUuid.set(a.uuid,t);let i=null!=(n=e.childrenByParentUuid.get(t))?n:[];i.includes(a.uuid)||i.push(a.uuid),e.childrenByParentUuid.set(t,i),e.selectedChildByUuid.set(t,i.length-1)}return d(e,t[t.length-1].uuid)},f=(e,t)=>{let n=[],i=null!=t?t:u,r=new Set;for(;e.childrenByParentUuid.has(i);){if(r.has(i)){let e=Error("Circular reference detected in message tree at UUID: ".concat(i));throw(0,a.Cp)(e),e}r.add(i);let t=c(e.childrenByParentUuid,i);if(0===t.length)break;let s=c(e.selectedChildByUuid,i),o=c(e.messageByUuid,t[s]);n.push({...o,parent_message_uuid:i,nOptions:t.length,selectedOption:s}),i=o.uuid}return n};function p(e,t,n){var a;let i=c(e.parentByChildUuid,t.uuid),s=c(e.childrenByParentUuid,i),o=r()((null!=(a=t.selectedOption)?a:0)+n,0,s.length-1);e.selectedChildByUuid.set(i,o);let u=f(e,i);return d(e,u[u.length-1].uuid)}}}]);